generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "mysql"
}

// --- ENUM (Pilihan Tetap) ---
enum Role {
  super_admin
  admin_divisi
  admin_humaniora
  bph
  user
}

enum KategoriDivisi {
  bph
  peminatan
  pendukung
}

enum StatusKeanggotaan {
  pending
  pasif
  aktif
  bph
}

// --- MODEL DATABASE ---

model Divisi {
  id_divisi   Int            @id @default(autoincrement())
  nama_divisi String
  kode        String         @unique @db.Char(3) // Contoh: SFT, HRD
  kategori    KategoriDivisi
  deskripsi   String?        @db.Text
  
  // Relasi
  users       Users[]        @relation("PeminatanUser")
  agendas     Agenda[]
  
  createdAt   DateTime       @default(now())

  @@map("divisi")
}

model Akun {
  id_akun          String    @id @default(uuid()) // UUID otomatis
  email            String    @unique
  password         String
  role             Role      @default(user)
  is_approved      Boolean   @default(false)
  cookie_token     String?
  cookie_expiry    DateTime?
  kelola_divisi_id Int?      // Jika dia admin divisi tertentu
  
  // Relasi
  userProfile      Users?
  agendaCreated    Agenda[]

  createdAt        DateTime  @default(now())
  
  @@map("akun")
}

model Users {
  nim                String            @id @db.VarChar(20)
  id_akun            String            @unique
  nama_lengkap       String
  jurusan            String
  angkatan           Int               
  alasan             String?           @db.Text
  status_keanggotaan StatusKeanggotaan @default(pending)
  
  // Relasi: User punya 1 Divisi Peminatan
  divisi_peminatan_id Int?
  divisi              Divisi?          @relation("PeminatanUser", fields: [divisi_peminatan_id], references: [id_divisi])
  
  // Relasi: User punya 1 Akun
  akun                Akun             @relation(fields: [id_akun], references: [id_akun], onDelete: Cascade)
  
  // Relasi: User punya banyak Absensi
  absensi             Absensi[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("users")
}

model Agenda {
  id_agenda     Int      @id @default(autoincrement())
  judul         String
  deskripsi     String?  @db.Text
  id_divisi     Int
  kategori      String   @default("pelatihan") 
  tanggal       DateTime
  lokasi        String?
  
  token_absen   String   @db.VarChar(10)
  is_absen_open Boolean  @default(false)
  konten_materi String?  @db.LongText 
  file_lampiran String? 
  
  created_by    String
  
  divisi        Divisi   @relation(fields: [id_divisi], references: [id_divisi])
  creator       Akun     @relation(fields: [created_by], references: [id_akun])
  absensi       Absensi[]

  @@map("agenda")
}

model Absensi {
  id_absensi  Int      @id @default(autoincrement())
  id_agenda   Int
  nim         String
  waktu_input DateTime @default(now())
  status      String   @default("hadir") 

  agenda      Agenda   @relation(fields: [id_agenda], references: [id_agenda], onDelete: Cascade)
  user        Users    @relation(fields: [nim], references: [nim], onDelete: Cascade)

  @@unique([id_agenda, nim]) // Satu user cuma bisa absen 1x per agenda
  @@map("absensi")
}